
"""
1D Plasticity
"""
function (op::Operator{:РѕФvРѓЊ¤Ѓdx})(ap::T,k::AbstractMatrix{Float64},fint::AbstractVector) where T<:AbstractElement
    ­ЮЊњ = ap.­ЮЊњ; ­ЮЊќ = ap.­ЮЊќ
    E = op.E
    K = op.K
    ¤Ѓy = op.¤Ѓy
    for ╬Й in ­ЮЊќ
        B = ╬Й[:Рѕѓ­ЮЮГРѕѓx]
        ¤ЃРѓЎ = ╬Й.¤ЃРѓЎ
        ╬▒РѓЎ = ╬Й.╬▒РѓЎ
        ╬хрхќРѓЎ = ╬Й.╬хрхќРѓЎ
        ­ЮЉц = ╬Й.­ЮЉц
        ╬ћ╬хРѓЎ = 0.0
        for (i,xрхб) in enumerate(­ЮЊњ)
            ╬ћ╬хРѓЎ += B[i]*xрхб.╬ћd
        end
        # predict phase
        ¤ЃрхЌ╩│ = ¤ЃРѓЎ+E*╬ћ╬хРѓЎ
        fрхЌ╩│ = abs(¤ЃрхЌ╩│) - (¤Ѓy+K*╬▒РѓЎ)
        if fрхЌ╩│ > 1E-13
            ╬ћ╬│ = fрхЌ╩│/(E+K)
            ╬Й.¤ЃРѓЎ = ¤ЃрхЌ╩│ - ╬ћ╬│*E*sign(¤ЃрхЌ╩│)
            ╬Й.╬хрхќРѓЎ = ╬хрхќРѓЎ + ╬ћ╬│*sign(¤ЃрхЌ╩│)
            ╬Й.╬▒РѓЎ = ╬▒РѓЎ + ╬ћ╬│
            EРѓю = (E*K)/(E+K)
        else
            ╬Й.¤ЃРѓЎ = ¤ЃрхЌ╩│
            EРѓю = E
        end
        for (i,xрхб) in enumerate(­ЮЊњ)
            I = xрхб.­Юљ╝
            for (j,xР▒╝) in enumerate(­ЮЊњ)
                J = xР▒╝.­Юљ╝
                k[I,J] += B[i]*EРѓю*B[j]*­ЮЉц
            end
            fint[I] += B[i]*╬Й.¤ЃРѓЎ*­ЮЉц
        end
    end
end

"""
Tresca
"""
function (op::Operator{:РѕФvрхб¤Ѓd╬Е_tresca})(ap::T;k::AbstractMatrix{Float64},fint::AbstractVector{Float64}) where T<:AbstractElement
    ­ЮЊњ = ap.­ЮЊњ; ­ЮЊќ = ap.­ЮЊќ
    ╬╗ = op.╬╗
    ╬╝ = op.╬╝
    c = op.c
    Cрхбрхбрхбрхб = ╬╗ + 2.0*╬╝
    CрхбрхбР▒╝Р▒╝ = ╬╗
    CрхбР▒╝рхбР▒╝ = ╬╝
    
    # for ╬Й in ­ЮЊќ
    for (ii,╬Й) in enumerate(­ЮЊќ)
        BРѓЂ = ╬Й[:Рѕѓ­ЮЮГРѕѓx]
        BРѓѓ = ╬Й[:Рѕѓ­ЮЮГРѕѓy]
        ¤ЃРѓЂРѓЂ = ╬Й.¤ЃРѓЂРѓЂ
        ¤ЃРѓѓРѓѓ = ╬Й.¤ЃРѓѓРѓѓ
        ¤ЃРѓЂРѓѓ = ╬Й.¤ЃРѓЂРѓѓ
        ╬хрхќРѓЂРѓЂ = ╬Й.╬хрхќРѓЂРѓЂ
        ╬хрхќРѓѓРѓѓ = ╬Й.╬хрхќРѓѓРѓѓ
        ╬хрхќРѓЂРѓѓ = ╬Й.╬хрхќРѓЂРѓѓ
        ­ЮЉц = ╬Й.­ЮЉц
        ╬ћ╬хРѓЂРѓЂ = 0.0
        ╬ћ╬хРѓѓРѓѓ = 0.0
        ╬ћ╬хРѓЂРѓѓ = 0.0
        for (i,xрхб) in enumerate(­ЮЊњ)
            ╬ћ╬хРѓЂРѓЂ += BРѓЂ[i]*xрхб.╬ћdРѓЂ
            ╬ћ╬хРѓѓРѓѓ += BРѓѓ[i]*xрхб.╬ћdРѓѓ
            ╬ћ╬хРѓЂРѓѓ += BРѓЂ[i]*xрхб.╬ћdРѓѓ + BРѓѓ[i]*xрхб.╬ћdРѓЂ
        end 

        # predict phase
        ¤ЃРѓЂРѓЂрхЌ╩│ = ¤ЃРѓЂРѓЂ + Cрхбрхбрхбрхб*╬ћ╬хРѓЂРѓЂ+CрхбрхбР▒╝Р▒╝*╬ћ╬хРѓѓРѓѓ
        ¤ЃРѓѓРѓѓрхЌ╩│ = ¤ЃРѓѓРѓѓ + Cрхбрхбрхбрхб*╬ћ╬хРѓѓРѓѓ+CрхбрхбР▒╝Р▒╝*╬ћ╬хРѓЂРѓЂ
        ¤ЃРѓЂРѓѓрхЌ╩│ = ¤ЃРѓЂРѓѓ + CрхбР▒╝рхбР▒╝*╬ћ╬хРѓЂРѓѓ
        ¤ЃРѓЂ,¤ЃРѓѓ,nРѓЂ,nРѓѓ = get¤ЃРѓЎ(¤ЃРѓЂРѓЂрхЌ╩│,¤ЃРѓѓРѓѓрхЌ╩│,¤ЃРѓЂРѓѓрхЌ╩│)
        fрхЌ╩│ = ¤ЃРѓЂ - ¤ЃРѓѓ - 2.0*c

        if fрхЌ╩│ > 1E-13
            ╬ћ╬│ = fрхЌ╩│/4.0/╬╝
           
            ╬Й.¤ЃРѓЂРѓЂ = ¤ЃРѓЂРѓЂрхЌ╩│ - ╬ћ╬│*2.0*╬╝*(nРѓЂ[1]*nРѓЂ[1] - nРѓѓ[1]*nРѓѓ[1])
            ╬Й.¤ЃРѓѓРѓѓ = ¤ЃРѓѓРѓѓрхЌ╩│ - ╬ћ╬│*2.0*╬╝*(nРѓЂ[2]*nРѓЂ[2] - nРѓѓ[2]*nРѓѓ[2])
            ╬Й.¤ЃРѓЂРѓѓ = ¤ЃРѓЂРѓѓрхЌ╩│ - ╬ћ╬│*2.0*╬╝*(nРѓЂ[1]*nРѓЂ[2] - nРѓѓ[1]*nРѓѓ[2])
            ╬Й.╬хрхќРѓЂРѓЂ = ╬хрхќРѓЂРѓЂ + ╬ћ╬│*(nРѓЂ[1]*nРѓЂ[1] - nРѓѓ[1]*nРѓѓ[1])
            ╬Й.╬хрхќРѓѓРѓѓ = ╬хрхќРѓѓРѓѓ + ╬ћ╬│*(nРѓЂ[2]*nРѓЂ[2] - nРѓѓ[2]*nРѓѓ[2])
            ╬Й.╬хрхќРѓЂРѓѓ = ╬хрхќРѓЂРѓѓ + ╬ћ╬│*(nРѓЂ[1]*nРѓЂ[2] - nРѓѓ[1]*nРѓѓ[2])

            CрхЌРѓЂРѓЂРѓЂРѓЂ = Cрхбрхбрхбрхб - ╬╝*(nРѓЂ[1]*nРѓЂ[1] - nРѓѓ[1]*nРѓѓ[1])^2
            CрхЌРѓѓРѓѓРѓѓРѓѓ = Cрхбрхбрхбрхб - ╬╝*(nРѓЂ[2]*nРѓЂ[2] - nРѓѓ[2]*nРѓѓ[2])^2
            CрхЌРѓЂРѓЂРѓѓРѓѓ = CрхбрхбР▒╝Р▒╝ - ╬╝*(nРѓЂ[1]*nРѓЂ[1] - nРѓѓ[1]*nРѓѓ[1])*(nРѓЂ[2]*nРѓЂ[2] - nРѓѓ[2]*nРѓѓ[2])
            CрхЌРѓЂРѓѓРѓЂРѓѓ = CрхбР▒╝рхбР▒╝ - 2.0*╬╝*(nРѓЂ[1]*nРѓЂ[2] - nРѓѓ[1]*nРѓѓ[2])^2
            CрхЌРѓЂРѓЂРѓЂРѓѓ = - ╬╝*(nРѓЂ[1]*nРѓЂ[1] - nРѓѓ[1]*nРѓѓ[1])*(nРѓЂ[1]*nРѓЂ[2] - nРѓѓ[1]*nРѓѓ[2])
            CрхЌРѓѓРѓѓРѓЂРѓѓ = - ╬╝*(nРѓЂ[2]*nРѓЂ[2] - nРѓѓ[2]*nРѓѓ[2])*(nРѓЂ[1]*nРѓЂ[2] - nРѓѓ[1]*nРѓѓ[2])
             #println(CрхЌРѓЂРѓЂРѓЂРѓЂ)
             #println(CрхЌРѓѓРѓѓРѓѓРѓѓ)
             #println(CрхЌРѓЂРѓЂРѓѓРѓѓ)
             #println(CрхЌРѓЂРѓѓРѓЂРѓѓ)
             #println(CрхЌРѓЂРѓЂРѓЂРѓѓ)
             #println(CрхЌРѓѓРѓѓРѓЂРѓѓ)
        else
            ╬Й.¤ЃРѓЂРѓЂ = ¤ЃРѓЂРѓЂрхЌ╩│
            ╬Й.¤ЃРѓѓРѓѓ = ¤ЃРѓѓРѓѓрхЌ╩│
            ╬Й.¤ЃРѓЂРѓѓ = ¤ЃРѓЂРѓѓрхЌ╩│
            CрхЌРѓЂРѓЂРѓЂРѓЂ = Cрхбрхбрхбрхб
            CрхЌРѓѓРѓѓРѓѓРѓѓ = Cрхбрхбрхбрхб
            CрхЌРѓЂРѓЂРѓѓРѓѓ = CрхбрхбР▒╝Р▒╝
            CрхЌРѓЂРѓѓРѓЂРѓѓ = CрхбР▒╝рхбР▒╝
            CрхЌРѓЂРѓЂРѓЂРѓѓ = 0.0
            CрхЌРѓѓРѓѓРѓЂРѓѓ = 0.0
        end
       
        for (i,xрхб) in enumerate(­ЮЊњ)
            I = xрхб.­Юљ╝
            for (j,xР▒╝) in enumerate(­ЮЊњ)
                J = xР▒╝.­Юљ╝
                k[2*I-1,2*J-1] += (CрхЌРѓЂРѓЂРѓЂРѓЂ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*(BРѓЂ[i]*BРѓѓ[j]+BРѓѓ[i]*BРѓЂ[j]))*­ЮЉц
                k[2*I-1,2*J]   += (CрхЌРѓЂРѓЂРѓѓРѓѓ*BРѓЂ[i]*BРѓѓ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓЂ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j])*­ЮЉц
                k[2*I,2*J-1]   += (CрхЌРѓЂРѓЂРѓѓРѓѓ*BРѓѓ[i]*BРѓЂ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓЂ[i]*BРѓѓ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j])*­ЮЉц
                k[2*I,2*J]     += (CрхЌРѓѓРѓѓРѓѓРѓѓ*BРѓѓ[i]*BРѓѓ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*(BРѓЂ[i]*BРѓѓ[j]+BРѓѓ[i]*BРѓЂ[j]))*­ЮЉц
     
            end
            fint[2*I-1] += BРѓЂ[i]*╬Й.¤ЃРѓЂРѓЂ*­ЮЉц + BРѓѓ[i]*╬Й.¤ЃРѓЂРѓѓ*­ЮЉц
            fint[2*I]   += BРѓЂ[i]*╬Й.¤ЃРѓЂРѓѓ*­ЮЉц + BРѓѓ[i]*╬Й.¤ЃРѓѓРѓѓ*­ЮЉц
        end
    end
end    

"""
morh-coulbom
"""
function (op::Operator{:РѕФvрхб¤Ѓd╬Е_mohr_coulomb})(ap::T;k::AbstractMatrix{Float64},fint::AbstractVector{Float64}) where T<:AbstractElement
    ­ЮЊњ = ap.­ЮЊњ; ­ЮЊќ = ap.­ЮЊќ
    ╬╗ = op.╬╗
    ╬╝ = op.╬╝
    c = op.c
    ­ЮюЎ = op.­ЮюЎ
    tol = op.tol 
    Cрхбрхбрхбрхб = ╬╗ + 2.0*╬╝
    CрхбрхбР▒╝Р▒╝ = ╬╗
    CрхбР▒╝рхбР▒╝ = ╬╝
    
    for (ii,╬Й) in enumerate(­ЮЊќ)
        BРѓЂ = ╬Й[:Рѕѓ­ЮЮГРѕѓx]
        BРѓѓ = ╬Й[:Рѕѓ­ЮЮГРѕѓy]
        ¤ЃРѓЂРѓЂ = ╬Й.¤ЃРѓЂРѓЂ
        ¤ЃРѓѓРѓѓ = ╬Й.¤ЃРѓѓРѓѓ
        ¤ЃРѓЃРѓЃ = ╬Й.¤ЃРѓЃРѓЃ
        ¤ЃРѓЂРѓѓ = ╬Й.¤ЃРѓЂРѓѓ
        ╬хрхќРѓЂРѓЂ = ╬Й.╬хрхќРѓЂРѓЂ
        ╬хрхќРѓѓРѓѓ = ╬Й.╬хрхќРѓѓРѓѓ
        ╬хрхќРѓЂРѓѓ = ╬Й.╬хрхќРѓЂРѓѓ
        ­ЮЉц = ╬Й.­ЮЉц
        ╬ћ╬хРѓЂРѓЂ = 0.0
        ╬ћ╬хРѓѓРѓѓ = 0.0
        ╬ћ╬хРѓЂРѓѓ = 0.0
        for (i,xрхб) in enumerate(­ЮЊњ)
            ╬ћ╬хРѓЂРѓЂ += BРѓЂ[i]*xрхб.╬ћdРѓЂ
            ╬ћ╬хРѓѓРѓѓ += BРѓѓ[i]*xрхб.╬ћdРѓѓ
            ╬ћ╬хРѓЂРѓѓ += BРѓЂ[i]*xрхб.╬ћdРѓѓ + BРѓѓ[i]*xрхб.╬ћdРѓЂ
        end 

        N = ╬Й[:­ЮЮГ]
        v = 0.0
        РѕѓvРѕѓx = 0.0
        for (i,xрхб) in enumerate(­ЮЊњ)
            v += N[i]*xрхб.v
            РѕѓvРѕѓx += B[i]*xрхб.v
        end
        # predict phase
        ¤ЃРѓЂРѓЂрхЌ╩│ = ¤ЃРѓЂРѓЂ + Cрхбрхбрхбрхб*╬ћ╬хРѓЂРѓЂ+CрхбрхбР▒╝Р▒╝*╬ћ╬хРѓѓРѓѓ
        ¤ЃРѓѓРѓѓрхЌ╩│ = ¤ЃРѓѓРѓѓ + Cрхбрхбрхбрхб*╬ћ╬хРѓѓРѓѓ+CрхбрхбР▒╝Р▒╝*╬ћ╬хРѓЂРѓЂ
        ¤ЃРѓЂРѓѓрхЌ╩│ = ¤ЃРѓЂРѓѓ + CрхбР▒╝рхбР▒╝*╬ћ╬хРѓЂРѓѓ
        ¤ЃРѓЂ,¤ЃРѓѓ,nРѓЂ,nРѓѓ = get¤ЃРѓЎ(¤ЃРѓЂРѓЂрхЌ╩│,¤ЃРѓѓРѓѓрхЌ╩│,¤ЃРѓЂРѓѓрхЌ╩│)
        fрхЌ╩│ = ¤ЃРѓЂ-¤ЃРѓѓ + (¤ЃРѓЂ+¤ЃРѓѓ) * sin(­ЮюЎ) - 2.0*c*cos(­ЮюЎ)
        #if fрхЌ╩│ > tol
        #    
        #  error("fрхЌ╩│ > tol!")
        #end
        if fрхЌ╩│ > tol
            sin­ЮюЎ = sin(­ЮюЎ)
            sin┬▓­ЮюЎ = sin(­ЮюЎ)*sin(­ЮюЎ)
            sin┬▓­ЮюЎpsin­ЮюЎ = sin┬▓­ЮюЎ +sin(­ЮюЎ) 
            sin┬▓­ЮюЎdsin­ЮюЎ = sin┬▓­ЮюЎ -sin(­ЮюЎ) 
            РѕѓfCРѕѓf=(4.0*sin┬▓­ЮюЎ*╬╗+4.0*(1.0+sin┬▓­ЮюЎ)*╬╝)
            ╬ћ╬│ = fрхЌ╩│/РѕѓfCРѕѓf
           
            ╬Й.¤ЃРѓЂРѓЂ = ¤ЃРѓЂРѓЂрхЌ╩│ - ╬ћ╬│*(2*sin­ЮюЎ*╬╗+2*((sin­ЮюЎ+1)*nРѓЂ[1]*nРѓЂ[1]+(sin­ЮюЎ-1)*nРѓѓ[1]*nРѓѓ[1])*╬╝)#СИіТаЄ1т»╣т║ћС╣ІтЅЇСИІТаЄ1
            ╬Й.¤ЃРѓѓРѓѓ = ¤ЃРѓѓРѓѓрхЌ╩│ - ╬ћ╬│*(2*sin­ЮюЎ*╬╗+2*((sin­ЮюЎ+1)*nРѓЂ[2]*nРѓЂ[2]+(sin­ЮюЎ-1)*nРѓѓ[2]*nРѓѓ[2])*╬╝)
            ╬Й.¤ЃРѓЂРѓѓ = ¤ЃРѓЂРѓѓрхЌ╩│ - ╬ћ╬│*2*((sin­ЮюЎ+1)*nРѓЂ[1]*nРѓЂ[2]+(sin­ЮюЎ-1)*nРѓѓ[1]*nРѓѓ[2])*╬╝
            ╬Й.╬хрхќРѓЂРѓЂ = ╬хрхќРѓЂРѓЂ + ╬ћ╬│*((sin­ЮюЎ+1)*nРѓЂ[1]*nРѓЂ[1]+(sin­ЮюЎ-1)nРѓѓ[1]*nРѓѓ[1])
            ╬Й.╬хрхќРѓѓРѓѓ = ╬хрхќРѓѓРѓѓ + ╬ћ╬│*((sin­ЮюЎ+1)*nРѓЂ[2]*nРѓЂ[2]+(sin­ЮюЎ-1)nРѓѓ[2]*nРѓѓ[2])
            ╬Й.╬хрхќРѓЂРѓѓ = ╬хрхќРѓЂРѓѓ + ╬ћ╬│*(((sin­ЮюЎ+1)*nРѓЂ[1]*nРѓЂ[2]+(sin­ЮюЎ-1)nРѓѓ[1]*nРѓѓ[2]))

            CрхЌРѓЂРѓЂРѓЂРѓЂ=Cрхбрхбрхбрхб-(4.0*sin┬▓­ЮюЎ*╬╗^2 + 8.0*sin┬▓­ЮюЎpsin­ЮюЎ*╬╗*╬╝*(nРѓЂ[1])^2 + 8.0*(sin┬▓­ЮюЎdsin­ЮюЎ)*╬╗*╬╝*(nРѓѓ[1])^2-8.0*cos(­ЮюЎ)*cos(­ЮюЎ)*╬╝^2*nРѓЂ[1]^2*nРѓѓ[1]^2+4.0*(sin­ЮюЎ+1)^2*╬╝^2*(nРѓЂ[1])^4+4.0*(sin­ЮюЎ-1)^2*╬╝^2*(nРѓѓ[1])^4)/РѕѓfCРѕѓf
            CрхЌРѓѓРѓѓРѓѓРѓѓ=Cрхбрхбрхбрхб-(4.0*sin┬▓­ЮюЎ*╬╗^2 + 8.0*sin┬▓­ЮюЎpsin­ЮюЎ*╬╗*╬╝*(nРѓЂ[2])^2 + 8.0*(sin┬▓­ЮюЎdsin­ЮюЎ)*╬╗*╬╝*(nРѓѓ[2])^2-8.0*cos(­ЮюЎ)*cos(­ЮюЎ)*╬╝^2*nРѓЂ[2]^2*nРѓѓ[2]^2+4.0*(sin­ЮюЎ+1)^2*╬╝^2*(nРѓЂ[2])^4+4.0*(sin­ЮюЎ-1)^2*╬╝^2*(nРѓѓ[2])^4)/РѕѓfCРѕѓf
            CрхЌРѓЂРѓЂРѓѓРѓѓ=CрхбрхбР▒╝Р▒╝-(4.0*sin┬▓­ЮюЎ*╬╗^2 + 4.0*sin┬▓­ЮюЎpsin­ЮюЎ*╬╗*╬╝*((nРѓЂ[1])^2+(nРѓЂ[2])^2)+4.0*(sin┬▓­ЮюЎdsin­ЮюЎ)*╬╗*╬╝*((nРѓѓ[1])^2+(nРѓѓ[2])^2)+4.0*(sin­ЮюЎ+1)^2*╬╝^2*(nРѓЂ[1])^2*(nРѓЂ[2])^2-4.0*cos(­ЮюЎ)*cos(­ЮюЎ)*╬╝^2*((nРѓѓ[1])^2*(nРѓЂ[2])^2+(nРѓЂ[1])^2*(nРѓѓ[2])^2)+4.0*(sin­ЮюЎ-1)^2*╬╝^2*(nРѓѓ[1])^2*(nРѓѓ[2])^2)/РѕѓfCРѕѓf
            CрхЌРѓЂРѓѓРѓЂРѓѓ=CрхбР▒╝рхбР▒╝-2.0(-8.0*cos(­ЮюЎ)*cos(­ЮюЎ)*╬╝^2*nРѓЂ[1]*nРѓЂ[2]*nРѓѓ[1]*nРѓѓ[2]+4.0*(sin­ЮюЎ+1)^2*╬╝^2*(nРѓЂ[1]*nРѓЂ[2])^2+4.0*(sin­ЮюЎ-1)^2*╬╝^2*(nРѓѓ[1]*nРѓѓ[2])^2)/РѕѓfCРѕѓf
            CрхЌРѓЂРѓЂРѓЂРѓѓ = - (4.0*sin┬▓­ЮюЎpsin­ЮюЎ*╬╗*╬╝*nРѓЂ[1]*nРѓЂ[2] + 4.0*(sin┬▓­ЮюЎdsin­ЮюЎ)*╬╗*╬╝*nРѓѓ[1]*nРѓѓ[2]-4.0*cos(­ЮюЎ)*cos(­ЮюЎ)*╬╝^2*nРѓѓ[1]^2*nРѓЂ[1]*nРѓЂ[2]-4.0*cos(­ЮюЎ)*cos(­ЮюЎ)*╬╝^2*nРѓЂ[1]^2*nРѓѓ[1]*nРѓѓ[2]+4.0*(sin­ЮюЎ+1)^2*╬╝^2*(nРѓЂ[1])^3*nРѓЂ[2]+4.0*(sin­ЮюЎ-1)^2*╬╝^2*(nРѓѓ[1])^3*nРѓѓ[2])/РѕѓfCРѕѓf
            CрхЌРѓѓРѓѓРѓЂРѓѓ = - (4.0*sin┬▓­ЮюЎpsin­ЮюЎ*╬╗*╬╝*nРѓЂ[2]*nРѓЂ[1] + 4.0*(sin┬▓­ЮюЎdsin­ЮюЎ)*╬╗*╬╝*nРѓѓ[2]*nРѓѓ[1]-4.0*cos(­ЮюЎ)*cos(­ЮюЎ)*╬╝^2*nРѓѓ[2]^2*nРѓЂ[2]*nРѓЂ[1]-4.0*cos(­ЮюЎ)*cos(­ЮюЎ)*╬╝^2*nРѓЂ[2]^2*nРѓѓ[2]*nРѓѓ[1]+4.0*(sin­ЮюЎ+1)^2*╬╝^2*(nРѓЂ[2])^3*nРѓЂ[1]+4.0*(sin­ЮюЎ-1)^2*╬╝^2*(nРѓѓ[2])^3*nРѓѓ[1])/РѕѓfCРѕѓf
            #println(CрхЌРѓЂРѓЂРѓЂРѓЂ)
            #println(CрхЌРѓѓРѓѓРѓѓРѓѓ)
            #println(CрхЌРѓЂРѓЂРѓѓРѓѓ)
            #println(CрхЌРѓЂРѓѓРѓЂРѓѓ)
            #println(CрхЌРѓЂРѓЂРѓЂРѓѓ)
            #println(CрхЌРѓѓРѓѓРѓЂРѓѓ)
        else
            ╬Й.¤ЃРѓЂРѓЂ = ¤ЃРѓЂРѓЂрхЌ╩│
            ╬Й.¤ЃРѓѓРѓѓ = ¤ЃРѓѓРѓѓрхЌ╩│
            ╬Й.¤ЃРѓЂРѓѓ = ¤ЃРѓЂРѓѓрхЌ╩│
            CрхЌРѓЂРѓЂРѓЂРѓЂ = Cрхбрхбрхбрхб
            CрхЌРѓѓРѓѓРѓѓРѓѓ = Cрхбрхбрхбрхб
            CрхЌРѓЂРѓЂРѓѓРѓѓ = CрхбрхбР▒╝Р▒╝
            CрхЌРѓЂРѓѓРѓЂРѓѓ = CрхбР▒╝рхбР▒╝
            CрхЌРѓЂРѓЂРѓЂРѓѓ = 0.0
            CрхЌРѓѓРѓѓРѓЂРѓѓ = 0.0
        end
       # if isnan(¤ЃРѓЂРѓЂ)
       #    
       #       ¤ЃРѓЂРѓЂ = NaN
       #       error("уеІт║Ју╗ѕТГб№╝џ¤ЃРѓЂРѓЂуџётђ╝СИ║NaN")
       # end
        # println(CрхЌРѓЂРѓЂРѓЂРѓЂ)
        # println(CрхЌРѓѓРѓѓРѓѓРѓѓ)
        # println(CрхЌРѓЂРѓЂРѓѓРѓѓ)
        # println(CрхЌРѓЂРѓѓРѓЂРѓѓ)
       
        for (i,xрхб) in enumerate(­ЮЊњ)
            I = xрхб.­Юљ╝
            for (j,xР▒╝) in enumerate(­ЮЊњ)
                J = xР▒╝.­Юљ╝
                k[2*I-1,2*J-1] += (CрхЌРѓЂРѓЂРѓЂРѓЂ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*(BРѓЂ[i]*BРѓѓ[j]+BРѓѓ[i]*BРѓЂ[j]))*­ЮЉц
                k[2*I-1,2*J]   += (CрхЌРѓЂРѓЂРѓѓРѓѓ*BРѓЂ[i]*BРѓѓ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓЂ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j])*­ЮЉц
                k[2*I,2*J-1]   += (CрхЌРѓЂРѓЂРѓѓРѓѓ*BРѓѓ[i]*BРѓЂ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓЂ[i]*BРѓѓ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j])*­ЮЉц
                k[2*I,2*J]     += (CрхЌРѓѓРѓѓРѓѓРѓѓ*BРѓѓ[i]*BРѓѓ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*(BРѓЂ[i]*BРѓѓ[j]+BРѓѓ[i]*BРѓЂ[j]))*­ЮЉц
     
            end
            fint[2*I-1] += BРѓЂ[i]*╬Й.¤ЃРѓЂРѓЂ*­ЮЉц + BРѓѓ[i]*╬Й.¤ЃРѓЂРѓѓ*­ЮЉц
            fint[2*I]   += BРѓЂ[i]*╬Й.¤ЃРѓЂРѓѓ*­ЮЉц + BРѓѓ[i]*╬Й.¤ЃРѓѓРѓѓ*­ЮЉц
    
        end
    end
end    


"""
frictional-contact
"""
function (op::Operator{:РѕФvрхб¤Ѓd╬Е_frictional_contact})(ap::T;k::AbstractMatrix{Float64},fint::AbstractVector{Float64}) where T<:AbstractElement
    ­ЮЊњ = ap.­ЮЊњ; ­ЮЊќ = ap.­ЮЊќ
    ╬╗ = op.╬╗
    ╬╝ = op.╬╝
    ╬╝╠ё = op.╬╝╠ё 
    ╬и = op.╬и
    tol = op.tol 
    Cрхбрхбрхбрхб = ╬╗ + 2.0*╬╝
    CрхбрхбР▒╝Р▒╝ = ╬╗
    CрхбР▒╝рхбР▒╝ = ╬╝
    
    for ╬Й in ­ЮЊќ
        N = ╬Й[:­ЮЮГ]
        BРѓЂ = ╬Й[:Рѕѓ­ЮЮГРѕѓx]
        BРѓѓ = ╬Й[:Рѕѓ­ЮЮГРѕѓy]
        ¤ЃРѓЂРѓЂ = ╬Й.¤ЃРѓЂРѓЂ
        ¤ЃРѓѓРѓѓ = ╬Й.¤ЃРѓѓРѓѓ
        ¤ЃРѓЂРѓѓ = ╬Й.¤ЃРѓЂРѓѓ
        ­ЮЉц   = ╬Й.­ЮЉц
        ╬хРѓЂРѓЂ = 0.0
        ╬хРѓѓРѓѓ = 0.0
        ╬хРѓЂРѓѓ = 0.0
        ╬ћ╬хРѓЂРѓЂ = 0.0
        ╬ћ╬хРѓѓРѓѓ = 0.0
        ╬ћ╬хРѓЂРѓѓ = 0.0
        v = 0.0
        РѕѓvРѕѓx = 0.0
        РѕѓvРѕѓy = 0.0
        for (i,xрхб) in enumerate(­ЮЊњ)
            ╬хРѓЂРѓЂ += BРѓЂ[i]*xрхб.dРѓЂ
            ╬хРѓѓРѓѓ += BРѓѓ[i]*xрхб.dРѓѓ
            ╬хРѓЂРѓѓ += BРѓЂ[i]*xрхб.dРѓѓ + BРѓѓ[i]*xрхб.dРѓЂ
            ╬ћ╬хРѓЂРѓЂ += BРѓЂ[i]*xрхб.╬ћdРѓЂ
            ╬ћ╬хРѓѓРѓѓ += BРѓѓ[i]*xрхб.╬ћdРѓѓ
            ╬ћ╬хРѓЂРѓѓ += BРѓЂ[i]*xрхб.╬ћdРѓѓ + BРѓѓ[i]*xрхб.╬ћdРѓЂ #1.У┐ЎжЄїу«ЌуџёСИцСИф
            v += N[i]*xрхб.v
            РѕѓvРѕѓx += BРѓЂ[i]*xрхб.v
            РѕѓvРѕѓy += BРѓѓ[i]*xрхб.v
        end 
        normРѕЄv = (РѕѓvРѕѓx^2+РѕѓvРѕѓy^2)^0.5#n = РѕЄv/norm(РѕЄv)
        nРѓЂ = РѕѓvРѕѓx/normРѕЄv
        nРѓѓ = РѕѓvРѕѓy/normРѕЄv
        sРѓЂ = nРѓѓ
        sРѓѓ = -nРѓЂ

        # predict phase
        ╬хРѓЎ = ╬хРѓЂРѓЂ*nРѓЂ*nРѓЂ + ╬хРѓѓРѓѓ*nРѓѓ*nРѓѓ + ╬хРѓЂРѓѓ*nРѓЂ*nРѓѓ#2.ТЅђС╗ЦУ┐ЎжЄїт░▒у«ЌСИђСИфт░▒УАїС║є
        ¤ЃРѓЂРѓЂрхЌ╩│ = ¤ЃРѓЂРѓЂ + Cрхбрхбрхбрхб*╬ћ╬хРѓЂРѓЂ+CрхбрхбР▒╝Р▒╝*╬ћ╬хРѓѓРѓѓ
        ¤ЃРѓѓРѓѓрхЌ╩│ = ¤ЃРѓѓРѓѓ + Cрхбрхбрхбрхб*╬ћ╬хРѓѓРѓѓ+CрхбрхбР▒╝Р▒╝*╬ћ╬хРѓЂРѓЂ
        ¤ЃРѓЂРѓѓрхЌ╩│ = ¤ЃРѓЂРѓѓ + CрхбР▒╝рхбР▒╝*╬ћ╬хРѓЂРѓѓ#№╝ЂТБђТЪЦ
        ¤ё = ¤ЃРѓЂРѓЂрхЌ╩│*nРѓЂ*sРѓЂ + ¤ЃРѓѓРѓѓрхЌ╩│*nРѓѓ*sРѓѓ + 2*¤ЃРѓЂРѓѓрхЌ╩│*nРѓЂ*sРѓѓ
        ¤Ѓ = ¤ЃРѓЂРѓЂрхЌ╩│*nРѓЂ*nРѓЂ + ¤ЃРѓѓРѓѓрхЌ╩│*nРѓѓ*nРѓѓ + 2*¤ЃРѓЂРѓѓрхЌ╩│*nРѓЂ*nРѓѓ

        ­ЮЉЊ = abs(¤ё) + ╬╝╠ё*¤Ѓ
        if v РЅѕ 0.0
           ╬Й.¤ЃРѓЂРѓЂ = ¤ЃРѓЂРѓЂрхЌ╩│
           ╬Й.¤ЃРѓѓРѓѓ = ¤ЃРѓѓРѓѓрхЌ╩│
           ╬Й.¤ЃРѓЂРѓѓ = ¤ЃРѓЂРѓѓрхЌ╩│
           CрхЌРѓЂРѓЂРѓЂРѓЂ = Cрхбрхбрхбрхб
           CрхЌРѓѓРѓѓРѓѓРѓѓ = Cрхбрхбрхбрхб
           CрхЌРѓЂРѓЂРѓѓРѓѓ = CрхбрхбР▒╝Р▒╝ 
           CрхЌРѓѓРѓѓРѓЂРѓЂ = CрхбрхбР▒╝Р▒╝
           CрхЌРѓЂРѓѓРѓЂРѓѓ = CрхбР▒╝рхбР▒╝ 
           CрхЌРѓЂРѓЂРѓЂРѓѓ = 0.0
           CрхЌРѓѓРѓѓРѓЂРѓѓ = 0.0
           CрхЌРѓЂРѓѓРѓЂРѓЂ = 0.0
           CрхЌРѓЂРѓѓРѓѓРѓѓ = 0.0
        else
            if ╬хРѓЎ > 0.0
               ╬Й.¤ЃРѓЂРѓЂ = (v^2+╬и)*¤ЃРѓЂРѓЂрхЌ╩│
               ╬Й.¤ЃРѓѓРѓѓ = (v^2+╬и)¤ЃРѓѓРѓѓрхЌ╩│
               ╬Й.¤ЃРѓЂРѓѓ = (v^2+╬и)¤ЃРѓЂРѓѓрхЌ╩│
               CрхЌРѓЂРѓЂРѓЂРѓЂ = (v^2+╬и)*Cрхбрхбрхбрхб
               CрхЌРѓѓРѓѓРѓѓРѓѓ = (v^2+╬и)*Cрхбрхбрхбрхб
               CрхЌРѓЂРѓЂРѓѓРѓѓ = (v^2+╬и)*CрхбрхбР▒╝Р▒╝ 
               CрхЌРѓѓРѓѓРѓЂРѓЂ = (v^2+╬и)*CрхбрхбР▒╝Р▒╝
               CрхЌРѓЂРѓѓРѓЂРѓѓ = (v^2+╬и)*CрхбР▒╝рхбР▒╝ 
               CрхЌРѓЂРѓЂРѓЂРѓѓ = 0.0
               CрхЌРѓѓРѓѓРѓЂРѓѓ = 0.0
               CрхЌРѓЂРѓѓРѓЂРѓЂ = 0.0
               CрхЌРѓЂРѓѓРѓѓРѓѓ = 0.0
            else
               if ­ЮЉЊ < tol
                   ╬Й.¤ЃРѓЂРѓЂ = ¤ЃРѓЂРѓЂрхЌ╩│
                   ╬Й.¤ЃРѓѓРѓѓ = ¤ЃРѓѓРѓѓрхЌ╩│
                   ╬Й.¤ЃРѓЂРѓѓ = ¤ЃРѓЂРѓѓрхЌ╩│
                   CрхЌРѓЂРѓЂРѓЂРѓЂ = Cрхбрхбрхбрхб
                   CрхЌРѓѓРѓѓРѓѓРѓѓ = Cрхбрхбрхбрхб
                   CрхЌРѓЂРѓЂРѓѓРѓѓ = CрхбрхбР▒╝Р▒╝ 
                   CрхЌРѓѓРѓѓРѓЂРѓЂ = CрхбрхбР▒╝Р▒╝
                   CрхЌРѓЂРѓѓРѓЂРѓѓ = CрхбР▒╝рхбР▒╝ 
                   CрхЌРѓЂРѓЂРѓЂРѓѓ = 0.0             
                   CрхЌРѓѓРѓѓРѓЂРѓѓ = 0.0
                   CрхЌРѓЂРѓѓРѓЂРѓЂ = 0.0
                   CрхЌРѓЂРѓѓРѓѓРѓѓ = 0.0
               else
                   ╬Й.¤ЃРѓЂРѓЂ = ¤ЃРѓЂРѓЂрхЌ╩│+(1-g(v))*(CрХаРѓЂРѓЂРѓЂРѓЂ-C╩│РѓЂРѓЂРѓЂРѓЂ)*╬хРѓЂРѓЂ
                   ╬Й.¤ЃРѓѓРѓѓ = ¤ЃРѓѓРѓѓрхЌ╩│+(1-g(v))*(CрХаРѓѓРѓѓРѓѓРѓѓ-C╩│РѓѓРѓѓРѓѓРѓѓ)*╬хРѓѓРѓѓ
                   ╬Й.¤ЃРѓЂРѓѓ = ¤ЃРѓЂРѓѓрхЌ╩│+(1-g(v))*(CрХаРѓЂРѓѓРѓЂРѓѓ-C╩│РѓЂРѓѓРѓЂРѓѓ)*╬хРѓЂРѓѓ
                   CрхЌРѓЂРѓЂРѓЂРѓЂ = Cрхбрхбрхбрхб +(1-g(v))*(CрХаРѓЂРѓЂРѓЂРѓЂ-C╩│РѓЂРѓЂРѓЂРѓЂ)
                   CрхЌРѓѓРѓѓРѓѓРѓѓ = Cрхбрхбрхбрхб +(1-g(v))*(CрХаРѓѓРѓѓРѓѓРѓѓ-C╩│РѓѓРѓѓРѓѓРѓѓ)
                   CрхЌРѓЂРѓЂРѓѓРѓѓ = CрхбрхбР▒╝Р▒╝ +(1-g(v))*(CрХаРѓЂРѓЂРѓѓРѓѓ-C╩│РѓЂРѓЂРѓѓРѓѓ)
                   CрхЌРѓѓРѓѓРѓЂРѓЂ = CрхбрхбР▒╝Р▒╝ +(1-g(v))*(CрХаРѓѓРѓѓРѓЂРѓЂ-C╩│РѓѓРѓѓРѓЂРѓЂ)
                   CрхЌРѓЂРѓѓРѓЂРѓѓ = CрхбР▒╝рхбР▒╝ +(1-g(v))*(CрХаРѓЂРѓѓРѓЂРѓѓ-C╩│РѓЂРѓѓРѓЂРѓѓ)
                   CрхЌРѓЂРѓЂРѓЂРѓѓ = 0.0   +(1-g(v))*(CрХаРѓЂРѓЂРѓЂРѓѓ-C╩│РѓЂРѓЂРѓЂРѓѓ)
                   CрхЌРѓѓРѓѓРѓЂРѓѓ = 0.0   +(1-g(v))*(CрХаРѓѓРѓѓРѓЂРѓѓ-C╩│РѓѓРѓѓРѓЂРѓѓ)
           
                end 
            end    
       end          
        for (i,xрхб) in enumerate(­ЮЊњ)
            I = xрхб.­Юљ╝
            for (j,xР▒╝) in enumerate(­ЮЊњ)
                J = xР▒╝.­Юљ╝
                k[2*I-1,2*J-1] += (CрхЌРѓЂРѓЂРѓЂРѓЂ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*(BРѓЂ[i]*BРѓѓ[j]+BРѓѓ[i]*BРѓЂ[j]))*­ЮЉц
                k[2*I-1,2*J]   += (CрхЌРѓЂРѓЂРѓѓРѓѓ*BРѓЂ[i]*BРѓѓ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓЂ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j])*­ЮЉц
                k[2*I,2*J-1]   += (CрхЌРѓѓРѓѓРѓЂРѓЂ*BРѓѓ[i]*BРѓЂ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓЂ[i]*BРѓѓ[j] + CрхЌРѓЂРѓЂРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*BРѓѓ[i]*BРѓѓ[j])*­ЮЉц
                k[2*I,2*J]     += (CрхЌРѓѓРѓѓРѓѓРѓѓ*BРѓѓ[i]*BРѓѓ[j] + CрхЌРѓЂРѓѓРѓЂРѓѓ*BРѓЂ[i]*BРѓЂ[j] + CрхЌРѓѓРѓѓРѓЂРѓѓ*(BРѓЂ[i]*BРѓѓ[j]+BРѓѓ[i]*BРѓЂ[j]))*­ЮЉц
     
            end
            fint[2*I-1] += BРѓЂ[i]*╬Й.¤ЃРѓЂРѓЂ*­ЮЉц + BРѓѓ[i]*╬Й.¤ЃРѓЂРѓѓ*­ЮЉц
            fint[2*I]   += BРѓЂ[i]*╬Й.¤ЃРѓЂРѓѓ*­ЮЉц + BРѓѓ[i]*╬Й.¤ЃРѓѓРѓѓ*­ЮЉц
    
        end
    end
end    
